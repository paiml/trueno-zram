# PMAT Quality Gate Configuration for trueno-zram
# Per testing-debugging-troubleshooting.md specification
#
# Batuta Stack Integration:
# - pmat: QA gating and project tracking (this file)
# - bashrs: Shell/Makefile/Dockerfile validation
# - probador: Test orchestration
# - renacer: Structured tracing and observability
#
# Toyota Way principles embedded:
# - Jidoka (automation with human touch): automated gates with manual override
# - Andon (stop the line): strict enforcement, pipeline halts on failure

[gates]
# ============================================================================
# Linting Gates
# ============================================================================
# Run clippy linter
run_clippy = true

# Enforce strict clippy (-D warnings)
clippy_strict = true

# Additional clippy lints for ublk daemon
clippy_extra_lints = [
    "clippy::unwrap_used",      # Prefer explicit error handling
    "clippy::expect_used",       # Document all expects
    "clippy::panic",             # No panics in daemon code
    "clippy::todo",              # No TODOs in production
]

# ============================================================================
# Test Gates
# ============================================================================
# Run test suite
run_tests = true

# Test timeout in seconds (ublk tests need more time)
test_timeout = 600

# Run integration tests
run_integration_tests = true

# Integration test command (Docker-based)
integration_test_command = "docker-compose -f docker/docker-compose.test.yml up --abort-on-container-exit component-tests"

# ============================================================================
# Coverage Gates
# ============================================================================
# Check code coverage
check_coverage = true

# Minimum line coverage percentage (per CLAUDE.md: 95%)
min_coverage = 95.0

# Minimum branch coverage
min_branch_coverage = 80.0

# Coverage tool
coverage_tool = "llvm-cov"

# Exclude from coverage (kernel-dependent code)
coverage_exclude = [
    "bins/trueno-ublk/src/ublk/daemon.rs",  # Requires kernel
    "bins/trueno-ublk/src/ublk/ctrl.rs",     # Requires kernel
]

# ============================================================================
# Complexity Gates
# ============================================================================
# Check cyclomatic complexity
check_complexity = true

# Maximum cyclomatic complexity per function
# Higher for SIMD code per .pmat-metrics.toml
max_complexity = 35

# Maximum cognitive complexity
max_cognitive_complexity = 140

# ============================================================================
# Security Gates
# ============================================================================
# Run cargo-audit for vulnerabilities
run_security_audit = true

# Deny advisories
deny_advisories = true

# RUSTSEC advisories to ignore (with justification)
ignore_advisories = []

# ============================================================================
# Documentation Gates
# ============================================================================
# Check documentation coverage
check_docs = true

# Minimum doc coverage for public items
min_doc_coverage = 80.0

# Require examples in docs
require_examples = false  # Kernel code can't have runnable examples

# ============================================================================
# Falsification Gates (Toyota Way: Hypothesis Testing)
# ============================================================================
[gates.falsification]
# Enable falsification matrix validation
enabled = true

# Minimum passing tests from F001-F100
min_passing = 50

# Critical tests that MUST pass (Andon triggers on failure)
critical_tests = [
    "F001",  # Device creation
    "F016",  # Read returns written data
    "F086",  # ext4 mkfs
    "F092",  # Swap works
]

# Maximum allowed failures before pipeline halt
max_failures = 10

# Skip reason must be documented
require_skip_justification = true

# ============================================================================
# Performance Gates
# ============================================================================
[gates.performance]
# Enable performance regression detection
enabled = true

# Benchmark command
benchmark_command = "cargo bench --bench compression_bench -- --save-baseline ci"

# Maximum allowed regression (percentage)
max_regression_percent = 10.0

# ============================================================================
# Docker Test Gates
# ============================================================================
[gates.docker]
# Enable Docker-based testing
enabled = true

# Docker compose file
compose_file = "docker/docker-compose.test.yml"

# Required passing services
required_services = [
    "unit-tests",
    "component-tests",
    "io-verification",
]

# Optional services (failures logged but don't block)
optional_services = [
    "stress-tests",
    "falsification",
]

# Timeout for Docker tests (seconds)
timeout = 1800

# ============================================================================
# Five-Whys Integration (Toyota Way)
# ============================================================================
[gates.five_whys]
# Enable Five-Whys analysis on failure
enabled = true

# Auto-generate Five-Whys template on test failure
auto_template = true

# Required fields in Five-Whys report
required_fields = [
    "problem_statement",
    "why_1",
    "why_2",
    "why_3",
    "why_4",
    "why_5",
    "root_cause",
    "countermeasure",
]

# Link failures to existing issues
link_to_issues = true

# ============================================================================
# Andon Configuration (Stop the Line)
# ============================================================================
[gates.andon]
# Conditions that trigger immediate pipeline halt
halt_conditions = [
    "data_corruption",      # Any I/O verification failure
    "security_advisory",    # Critical RUSTSEC advisory
    "memory_leak",          # Valgrind/MIRI detection
    "kernel_oops",          # dmesg shows kernel error
    "orphaned_resources",   # Devices/swap not cleaned up
]

# Notify on halt
notify_on_halt = true

# Notification channels (configure in CI)
# notify_channels = ["slack", "email"]

# ============================================================================
# Batuta Stack Integration (Section 3.5)
# ============================================================================
[gates.batuta]
# Enable Batuta Stack tooling validation
enabled = true

# bashrs: Validate all shell scripts, Makefiles, Dockerfiles
bashrs_validate = true
bashrs_paths = [
    "scripts/*.sh",
    "Makefile",
    "docker/Dockerfile.*",
]

# probador: Test orchestration
probador_enabled = true
probador_suites = ["unit", "integration", "falsification"]

# renacer: Structured tracing validation
renacer_enabled = true
renacer_level = "info"
renacer_format = "json"

# Require Batuta tools in Docker image
docker_require_tools = ["pmat", "bashrs", "probador", "renacer"]
